<html>
	<head>
		<script src='scripts/jquery-1.4.2.min.js'/> </script>
		<script src='scripts/jquery.jfeed.js'/> </script>
		<script src='scripts/options.js'> </script>
		<script src='scripts/log.js'> </script>
		<script src='scripts/background.js'> </script>
		<script src='scripts/feed_util.js'> </script>
		<script>
			/* author: david hamp-gonsalves */
			var feedOptionCount = 2;
			var seperator = '. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .';

			var feeds = Array();
            var intervalId;
			
			//sets the feeds to poll and sync
			function setFeeds(updatedFeeds)
			{
				feeds = updatedFeeds;
			}
            
      //sets the polling interval
      function setPollInterval(interval)
      {
          window.clearInterval(intervalId);
          intervalId = window.setInterval(pollFeeds, 1000 * 60 * interval);
      }
			
			//sets up the feeds and starts polling
			function init()
			{
				feeds = getFeedConfig();
				//set up a interval to pull
				intervalId = window.setInterval(pollFeeds, 1000 * 60 * getPollInterval());
				//poll right away for the first time
				pollFeeds();
			}
			
			//polls each configured feed with a delay between each to reduce load all at once
			function pollFeeds()
			{
				for(var i=0 ; feeds != undefined && i < feeds.length ; i++)
					//poll the feeds off set by a delay for quota and for load
					pollFeed(feeds[i], i * 1000 * 10);
			}
			
			//updates the feeds bookmarks(folder and items)
			function updateFeedBookmarks(feed, jFeed)
			{
				chrome.bookmarks.getTree(function(topNode){
					var folder;
					if(feed.parentFolder !== undefined)
					{
						folder = getBookmarkFolder(topNode, feed.parentFolder);
						if(folder === undefined)
							displayError("The parent folder: " + folder.title + " for feed: " + feed.name + " wasn't found");
					}
					if(folder === undefined)
						folder = getBookmarkBarFolder(topNode);
					updateFeedItems(folder, feed, jFeed);
				});
			}
	
			//updates the feeds items if things have changed by removing non-existant, sorting and adding items
			function updateFeedItems(feedFolder, feed, jFeed)
			{					
				//if the feed isn't updated then we don't need to do anything
				if(feed.updated != '' && jFeed.updated != '' && feed.updated === jFeed.updated)
					return;
				else
					feed.updated = jFeed.updated;

				updateFolder(feedFolder, feed, jFeed);
			}

			//creates the folder if it dosn't already exist and calls updateFeedItems 
			//to populate it
			function updateFolder(parentNode, feed, jFeed)
			{
				var feedFolder = undefined;
				var children = parentNode.children;
				for(var i in children)
				  //check that the title matches and also that the node isn't a bookmark by 
				  //checking if children returns undefined
				  if(children[i].title === feed.name && children[i].children != undefined)
						feedFolder = children[i];

				if(feedFolder === undefined)
					chrome.bookmarks.create({'parentId': parentNode.id,
						'title': feed.name},
						function(newFolder) {
							if(isError(newFolder))
								return;

							newFolder.children = [];
							syncFeedBookmarksByUpdatingFeedOptions(newFolder, feed, jFeed); 
					});
				else
					syncFeedBookmarksByUpdatingFeedOptions(feedFolder, feed, jFeed);
			}
			
			//adds the feed options section at the bottom of the feed if it doesn't 
			//exist already
			function syncFeedBookmarksByUpdatingFeedOptions(feedFolder, feed, jFeed, iter)
			{				
				if(iter === undefined)
					iter = 0;
				
				if(iter === feedOptionCount)
					syncFeedBookmarksByRemoving(feedFolder, feed, jFeed, 0);
				else 
				{
					var title, url;
					if(iter === 0 && !bookmarkExistsByTitle({'title': seperator}, feedFolder))
					{
						title = seperator;
						url = 'about:blank';
					}else if(iter === 1 && !bookmarkExistsByTitle({'title': 'Open "' + feed.name + '"'}, feedFolder))
					{
						title = 'Open "' + feed.name + '"';
						url = feed.siteUrl
					}else
					{
						//the current option exists so call the function for the next iteration
						syncFeedBookmarksByUpdatingFeedOptions(feedFolder, feed, jFeed, ++iter);
						return;
					}
					
					//insert the feed option
					addFeedItem(feedFolder, feed, jFeed, {title: title, url: url}, iter, syncFeedBookmarksByUpdatingFeedOptions)
				}
			}
			
			//removes feed bookmarks that no longer exist in current feed
			function syncFeedBookmarksByRemoving(feedFolder, feed, jFeed, iter)
			{
				//remove the bookmarks that dosn't exist in the feed anymore
				if(feedFolder.children != undefined && iter < feedFolder.children.length - feedOptionCount && 
					iter < feed.maxItems)
				{
					if(!itemExistsInFeed(feedFolder.children[iter], jFeed, feed))
						removeFeedItem(feedFolder, feed, jFeed, iter, syncFeedBookmarksByRemoving);
					else
						syncFeedBookmarksByRemoving(feedFolder, feed, jFeed, ++iter);
				}else
					//call next step in process which is to order the existing items
					syncFeedBookmarksBySorting(feedFolder, feed, jFeed, 0);
			}
			
			//sorts the feed bookmarks to match the new feed
			function syncFeedBookmarksBySorting(feedFolder, feed, jFeed, iter)
			{
				//sort the existing feed items
				if(iter < jFeed.items.length && iter < feed.maxItems)
				{
					for(var j=0 ; j < feedFolder.children.length - feedOptionCount ; j++)
						if(feedItemsMatch(feedFolder.children[j], jFeed.items[iter]))
						{
							if(j != iter)
							{
								moveFeedItem(feedFolder, feed, jFeed, iter, j, syncFeedBookmarksBySorting);
								return;
							}
							break;
						}
					syncFeedBookmarksBySorting(feedFolder, feed, jFeed, ++iter);
				}else
					//call next step in process which is to add the new items to the feed
					syncFeedBookmarksByAdding(feedFolder, feed, jFeed, 0)
			}
			
			//adds any feed items that don't exist in the folder
			function syncFeedBookmarksByAdding(feedFolder, feed, jFeed, iter)
			{
				//add the feed items that don't already exist in the correct positions
				if(iter < jFeed.items.length && iter < feed.maxItems)
				{
					var item = jFeed.items[iter];
					//if the feed item dosn't exist or it doesn't match then we need to create it in that position
					if(feedFolder.children[iter] != undefined && feedItemsMatch(item, feedFolder.children[iter]))
						syncFeedBookmarksByAdding(feedFolder, feed, jFeed, ++iter);
					else
						addFeedItem(feedFolder, feed, jFeed, item, iter, syncFeedBookmarksByAdding);
				}	
			}
			
			//checks if there is an error and displays the error if so
			function isError(result)
			{
				if (result === undefined)
				{
					//there was a quota limit exception
					displayError("The bookmark API limit was hit");
					return true;
				}else
					return false;
			}
			
			//display the quota limit error
			function displayError(errorText)
			{
				//log the msg for the user to see
				logError(errorText);
			}
			
			// pulls the feed after waiting for the passed in delay
			function pollFeed(feedToPoll, waitDelay)
			{
        var feed = feedToPoll;  
        var poll = function()
        {
					//poll the feed using the JQuery library
					jQuery.getFeed({ 
						url: feed.feedUrl, 
						success: success,
						error: error});
				}

        var success = function(jFeed)
				{
					if(jFeed.items === undefined)
						displayError(feed.name + ' was polled but contained no entries');
					else
						updateFeedBookmarks(feed, jFeed);
				};
				
				var error = function(errorText)
				{
					displayError('feed "' + feed.feedUrl + '" couldn\'t be pulled.  The error was: ' + errorText);
				};
				
				//delay and then poll the feeds
				window.setTimeout(poll, waitDelay);
			}
			
		</script>
	</head>
	<body onload='init()'>
	</body>
</html>
